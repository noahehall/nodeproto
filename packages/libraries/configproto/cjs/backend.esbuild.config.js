"use strict";var _utils=require("@nodeproto/utils"),_esbuild=require("esbuild"),_fs=require("fs"),_esbuildPluginManifest=require("esbuild-plugin-manifest"),_path=require("path"),_packageJson=require("../package.json"),_module=require("module");const appInputFilename="index",appExtension=".mjs",appId="index.mjs",manifestFilename="manifest.json",outdir=_path.default.resolve("dist"),manifestUri="undefined/manifest.json",conditions=process.execArgv.filter(a=>a.startsWith("--conditions")),isBuild=!!conditions.filter(b=>b.endsWith("build")).length,isDev=!isBuild;let servers;const stopDev=async()=>isDev&&(null==servers?void 0:servers.length)&&servers.forEach(c=>c.close()),startDev=async()=>{if(isBuild)return;await stopDev();const d=await _fs.default.promises.readFile("undefined/manifest.json","utf-8").then(e=>Promise.resolve().then(function(){return require("../"+JSON.parse(e)["index"])}));d&&(servers=await d.runApp())},buildLogAndDevOrStop=({errors,warnings,...f})=>{console.info("\n\n finished build\n",Object.keys(f.metafile.outputs)),(errors.length||warnings.length)&&console.warn("\n\n build notifications",{errors,warnings}),isDev?startDev():isBuild&&f.stop()},popCopyConfig={options:[{indir:(await _utils.fsproto.resolve("../app",import.meta.url)).replace("file://",""),outdir,endingWith:/openapi\.(yml|yaml)$/,recurse:!0},]},manifestPluginConfig={hash:!1,shortNames:!1,extensionless:"input",filename:"manifest.json"},esbuildConfig={assetNames:"assets/[name]-[hash]",bundle:!0,define:_utils.envproto.syncEnv(_packageJson.default).processEnv,entryNames:isDev?"[name]-[hash]":"[name]",entryPoints:["index.mjs"],external:_module.builtinModules,metafile:!0,minify:!1,outdir,outExtension:{".js":".cjs"},platform:"node",resolveExtensions:[".mjs",".js",".cjs",".json"],sourcemap:!0,target:["node14.17.0"],write:!0,plugins:[_utils.esproto.popCopy(popCopyConfig),_esbuildPluginManifest.default(manifestPluginConfig),],watch:{async onRebuild(g,h){buildLogAndDevOrStop(h),g&&console.error(g)}}},buildResult=await _esbuild.default.build(esbuildConfig);isBuild&&buildLogAndDevOrStop(buildResult)