"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

var _interopRequireWildcard2 = _interopRequireDefault(require("@babel/runtime/helpers/interopRequireWildcard"));

var _utils = require("@nodeproto/utils");

var _esbuild = _interopRequireDefault(require("esbuild"));

var _fs = _interopRequireDefault(require("fs"));

var _esbuildPluginManifest = _interopRequireDefault(require("esbuild-plugin-manifest"));

var _path = _interopRequireDefault(require("path"));

var _package = _interopRequireDefault(require("../package.json"));

var _module = require("module");

const appInputFilename = 'index';
const appExtension = '.mjs';
const appId = appInputFilename + appExtension;
const manifestFilename = 'manifest.json';

const outdir = _path.default.resolve('dist');

const manifestUri = outdir + '/' + manifestFilename;
const conditions = process.execArgv.filter(x => x.startsWith('--conditions'));
const isBuild = !!conditions.filter(x => x.endsWith('build')).length;
const isDev = !isBuild;
let servers = undefined;

const stopDev = async () => isDev && servers?.length && servers.forEach(s => s.close());

const startDev = async () => {
  if (isBuild) return;
  await stopDev();
  const newServers = await _fs.default.promises.readFile(manifestUri, 'utf-8').then(manifest => Promise.resolve(`${'../' + JSON.parse(manifest)[appInputFilename]}`).then(s => (0, _interopRequireWildcard2.default)(require(s))));
  if (newServers) servers = await newServers.runApp();
};

const buildLogAndDevOrStop = ({
  errors,
  warnings,
  ...result
}) => {
  console.info('\n\n finished build\n', Object.keys(result.metafile.outputs));
  if (errors.length || warnings.length) console.warn('\n\n build notifications', {
    errors,
    warnings
  });
  if (isDev) startDev();else if (isBuild) result.stop();
};

const popCopyConfig = {
  options: [{
    indir: (await _utils.fsproto.resolve('../app', import.meta.url)).replace('file://', ''),
    outdir,
    endingWith: /openapi\.(yml|yaml)$/,
    recurse: true
  }]
};
const manifestPluginConfig = {
  hash: false,
  shortNames: false,
  extensionless: 'input',
  filename: manifestFilename
};
const esbuildConfig = {
  assetNames: 'assets/[name]-[hash]',
  bundle: true,
  define: _utils.envproto.syncEnv(_package.default).processEnv,
  entryNames: isDev ? '[name]-[hash]' : '[name]',
  entryPoints: [appId],
  external: _module.builtinModules,
  metafile: true,
  minify: false,
  outdir,
  outExtension: {
    '.js': '.cjs'
  },
  platform: 'node',
  resolveExtensions: ['.mjs', '.js', '.cjs', '.json'],
  sourcemap: true,
  target: ['node14.17.0'],
  write: true,
  plugins: [_utils.esproto.popCopy(popCopyConfig), (0, _esbuildPluginManifest.default)(manifestPluginConfig)],
  watch: {
    async onRebuild(error, result) {
      buildLogAndDevOrStop(result);
      if (error) console.error(error);
    }

  }
};
const buildResult = await _esbuild.default.build(esbuildConfig);
isBuild && buildLogAndDevOrStop(buildResult);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzYnVpbGQvYmFja2VuZC5lc2J1aWxkLmNvbmZpZy5tanMiXSwibmFtZXMiOlsiYXBwSW5wdXRGaWxlbmFtZSIsImFwcEV4dGVuc2lvbiIsImFwcElkIiwibWFuaWZlc3RGaWxlbmFtZSIsIm91dGRpciIsInBhdGgiLCJyZXNvbHZlIiwibWFuaWZlc3RVcmkiLCJjb25kaXRpb25zIiwicHJvY2VzcyIsImV4ZWNBcmd2IiwiZmlsdGVyIiwieCIsInN0YXJ0c1dpdGgiLCJpc0J1aWxkIiwiZW5kc1dpdGgiLCJsZW5ndGgiLCJpc0RldiIsInNlcnZlcnMiLCJ1bmRlZmluZWQiLCJzdG9wRGV2IiwiZm9yRWFjaCIsInMiLCJjbG9zZSIsInN0YXJ0RGV2IiwibmV3U2VydmVycyIsImZzIiwicHJvbWlzZXMiLCJyZWFkRmlsZSIsInRoZW4iLCJtYW5pZmVzdCIsIkpTT04iLCJwYXJzZSIsInJ1bkFwcCIsImJ1aWxkTG9nQW5kRGV2T3JTdG9wIiwiZXJyb3JzIiwid2FybmluZ3MiLCJyZXN1bHQiLCJjb25zb2xlIiwiaW5mbyIsIk9iamVjdCIsImtleXMiLCJtZXRhZmlsZSIsIm91dHB1dHMiLCJ3YXJuIiwic3RvcCIsInBvcENvcHlDb25maWciLCJvcHRpb25zIiwiaW5kaXIiLCJmc3Byb3RvIiwiaW1wb3J0IiwibWV0YSIsInVybCIsInJlcGxhY2UiLCJlbmRpbmdXaXRoIiwicmVjdXJzZSIsIm1hbmlmZXN0UGx1Z2luQ29uZmlnIiwiaGFzaCIsInNob3J0TmFtZXMiLCJleHRlbnNpb25sZXNzIiwiZmlsZW5hbWUiLCJlc2J1aWxkQ29uZmlnIiwiYXNzZXROYW1lcyIsImJ1bmRsZSIsImRlZmluZSIsImVudnByb3RvIiwic3luY0VudiIsInBrZ0pzb24iLCJwcm9jZXNzRW52IiwiZW50cnlOYW1lcyIsImVudHJ5UG9pbnRzIiwiZXh0ZXJuYWwiLCJidWlsdGluTW9kdWxlcyIsIm1pbmlmeSIsIm91dEV4dGVuc2lvbiIsInBsYXRmb3JtIiwicmVzb2x2ZUV4dGVuc2lvbnMiLCJzb3VyY2VtYXAiLCJ0YXJnZXQiLCJ3cml0ZSIsInBsdWdpbnMiLCJlc3Byb3RvIiwicG9wQ29weSIsIndhdGNoIiwib25SZWJ1aWxkIiwiZXJyb3IiLCJidWlsZFJlc3VsdCIsImVzYnVpbGQiLCJidWlsZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsT0FBekI7QUFDQSxNQUFNQyxZQUFZLEdBQUcsTUFBckI7QUFDQSxNQUFNQyxLQUFLLEdBQUdGLGdCQUFnQixHQUFHQyxZQUFqQztBQUNBLE1BQU1FLGdCQUFnQixHQUFHLGVBQXpCOztBQUNBLE1BQU1DLE1BQU0sR0FBR0MsY0FBS0MsT0FBTCxDQUFhLE1BQWIsQ0FBZjs7QUFDQSxNQUFNQyxXQUFXLEdBQUdILE1BQU0sR0FBRyxHQUFULEdBQWVELGdCQUFuQztBQUVBLE1BQU1LLFVBQVUsR0FBR0MsT0FBTyxDQUFDQyxRQUFSLENBQWlCQyxNQUFqQixDQUF3QkMsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLFVBQUYsQ0FBYSxjQUFiLENBQTdCLENBQW5CO0FBQ0EsTUFBTUMsT0FBTyxHQUFHLENBQUMsQ0FBQ04sVUFBVSxDQUFDRyxNQUFYLENBQWtCQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0csUUFBRixDQUFXLE9BQVgsQ0FBdkIsRUFBNENDLE1BQTlEO0FBQ0EsTUFBTUMsS0FBSyxHQUFHLENBQUNILE9BQWY7QUFJQSxJQUFJSSxPQUFPLEdBQUdDLFNBQWQ7O0FBQ0EsTUFBTUMsT0FBTyxHQUFHLFlBQVlILEtBQUssSUFBSUMsT0FBTyxFQUFFRixNQUFsQixJQUE0QkUsT0FBTyxDQUFDRyxPQUFSLENBQWdCQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsS0FBRixFQUFyQixDQUF4RDs7QUFDQSxNQUFNQyxRQUFRLEdBQUcsWUFBWTtBQUMzQixNQUFJVixPQUFKLEVBQWE7QUFFYixRQUFPTSxPQUFPLEVBQWQ7QUFFQSxRQUFNSyxV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QUF1QmhELE1BQXZCLEVBQStCO0FBQzdCSCxNQUFBQSxvQkFBb0IsQ0FBQ0csTUFBRCxDQUFwQjtBQUVBLFVBQUlnRCxLQUFKLEVBQVcvQyxPQUFPLENBQUMrQyxLQUFSLENBQWNBLEtBQWQ7QUFDWjs7QUFMSTtBQXBCYSxDQUF0QjtBQWdDQSxNQUFNQyxXQUFXLEdBQUcsTUFBTUMsaUJBQVFDLEtBQVIsQ0FBYzNCLGFBQWQsQ0FBMUI7QUFDQS9DLE9BQU8sSUFBSW9CLG9CQUFvQixDQUFDb0QsV0FBRCxDQUEvQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQG5vZGVwcm90by9jb25maWdwcm90byAtIGVzYnVpbGQgY29uZmlnIGZpbGVcbiAqIGZ1bGwgZmVhdHVyZWQgZXNidWlsZCBjb25maWd1cmF0aW9uIGZvciBiYWNrZW5kIGFwcHNcbiAqL1xuaW1wb3J0IHsgZW52cHJvdG8sIGVzcHJvdG8sIGZzcHJvdG8gfSBmcm9tICdAbm9kZXByb3RvL3V0aWxzJztcbmltcG9ydCBlc2J1aWxkIGZyb20gJ2VzYnVpbGQnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBtYW5pZmVzdFBsdWdpbiBmcm9tICdlc2J1aWxkLXBsdWdpbi1tYW5pZmVzdCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBwa2dKc29uIGZyb20gJy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQgeyBidWlsdGluTW9kdWxlcyB9IGZyb20gJ21vZHVsZSc7XG5cbmNvbnN0IGFwcElucHV0RmlsZW5hbWUgPSAnaW5kZXgnO1xuY29uc3QgYXBwRXh0ZW5zaW9uID0gJy5tanMnO1xuY29uc3QgYXBwSWQgPSBhcHBJbnB1dEZpbGVuYW1lICsgYXBwRXh0ZW5zaW9uO1xuY29uc3QgbWFuaWZlc3RGaWxlbmFtZSA9ICdtYW5pZmVzdC5qc29uJztcbmNvbnN0IG91dGRpciA9IHBhdGgucmVzb2x2ZSgnZGlzdCcpO1xuY29uc3QgbWFuaWZlc3RVcmkgPSBvdXRkaXIgKyAnLycgKyBtYW5pZmVzdEZpbGVuYW1lO1xuXG5jb25zdCBjb25kaXRpb25zID0gcHJvY2Vzcy5leGVjQXJndi5maWx0ZXIoeCA9PiB4LnN0YXJ0c1dpdGgoJy0tY29uZGl0aW9ucycpKTtcbmNvbnN0IGlzQnVpbGQgPSAhIWNvbmRpdGlvbnMuZmlsdGVyKHggPT4geC5lbmRzV2l0aCgnYnVpbGQnKSkubGVuZ3RoXG5jb25zdCBpc0RldiA9ICFpc0J1aWxkOyAvLyBjYW50IGJlIGJvdGggZGV2IGFuZCBidWlsZFxuXG5cbi8vIGZvciBhdXRvIHN0YXJ0aW5nIGluIGRldlxubGV0IHNlcnZlcnMgPSB1bmRlZmluZWQ7XG5jb25zdCBzdG9wRGV2ID0gYXN5bmMgKCkgPT4gaXNEZXYgJiYgc2VydmVycz8ubGVuZ3RoICYmIHNlcnZlcnMuZm9yRWFjaChzID0+IHMuY2xvc2UoKSk7XG5jb25zdCBzdGFydERldiA9IGFzeW5jICgpID0+IHtcbiAgaWYgKGlzQnVpbGQpIHJldHVybjtcblxuICBhd2FpdCAoc3RvcERldigpKVxuXG4gIGNvbnN0IG5ld1NlcnZlcnMgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShtYW5pZmVzdFVyaSwgJ3V0Zi04JylcbiAgICAudGhlbihtYW5pZmVzdCA9PiBpbXBvcnQoJy4uLycgKyBKU09OLnBhcnNlKG1hbmlmZXN0KVthcHBJbnB1dEZpbGVuYW1lXSkpXG5cbiAgaWYgKG5ld1NlcnZlcnMpIHNlcnZlcnMgPSBhd2FpdCBuZXdTZXJ2ZXJzLnJ1bkFwcCgpO1xufVxuXG5jb25zdCBidWlsZExvZ0FuZERldk9yU3RvcCA9ICh7IGVycm9ycywgd2FybmluZ3MsIC4uLnJlc3VsdH0pID0+IHtcbiAgY29uc29sZS5pbmZvKCdcXG5cXG4gZmluaXNoZWQgYnVpbGRcXG4nLCBPYmplY3Qua2V5cyhyZXN1bHQubWV0YWZpbGUub3V0cHV0cykpO1xuXG4gIGlmIChlcnJvcnMubGVuZ3RoIHx8IHdhcm5pbmdzLmxlbmd0aClcbiAgICBjb25zb2xlLndhcm4oJ1xcblxcbiBidWlsZCBub3RpZmljYXRpb25zJywgeyBlcnJvcnMsIHdhcm5pbmdzIH0pO1xuXG4gIGlmIChpc0Rldikgc3RhcnREZXYoKTtcbiAgZWxzZSBpZiAoaXNCdWlsZCkgcmVzdWx0LnN0b3AoKTtcbn07XG5cbmNvbnN0IHBvcENvcHlDb25maWcgPSB7XG4gIG9wdGlvbnM6IFtcbiAgICB7XG4gICAgICBpbmRpcjogKGF3YWl0IGZzcHJvdG8ucmVzb2x2ZSgnLi4vYXBwJywgaW1wb3J0Lm1ldGEudXJsKSkucmVwbGFjZSgnZmlsZTovLycsICcnKSxcbiAgICAgIG91dGRpcixcbiAgICAgIGVuZGluZ1dpdGg6IC9vcGVuYXBpXFwuKHltbHx5YW1sKSQvLFxuICAgICAgcmVjdXJzZTogdHJ1ZSxcbiAgICB9LFxuICBdLFxufTtcblxuY29uc3QgbWFuaWZlc3RQbHVnaW5Db25maWcgPSB7XG4gIGhhc2g6IGZhbHNlLFxuICBzaG9ydE5hbWVzOiBmYWxzZSxcbiAgZXh0ZW5zaW9ubGVzczogJ2lucHV0JyxcbiAgZmlsZW5hbWU6IG1hbmlmZXN0RmlsZW5hbWUsXG59O1xuXG4vLyBjb25zdCBlbnYgPSBlbnZwcm90by5zeW5jRW52KHBrZ0pzb24pO1xuXG4vLyBjb25zb2xlLmxvZygnXFxuXFxuIGdvdCBlbnYnLCBlbnYpO1xuXG5jb25zdCBlc2J1aWxkQ29uZmlnID0ge1xuICBhc3NldE5hbWVzOiAnYXNzZXRzL1tuYW1lXS1baGFzaF0nLFxuICBidW5kbGU6IHRydWUsXG4gIGRlZmluZTogZW52cHJvdG8uc3luY0Vudihwa2dKc29uKS5wcm9jZXNzRW52LFxuICBlbnRyeU5hbWVzOiBpc0RldiA/ICdbbmFtZV0tW2hhc2hdJyA6ICdbbmFtZV0nLFxuICBlbnRyeVBvaW50czogW2FwcElkXSxcbiAgZXh0ZXJuYWw6IGJ1aWx0aW5Nb2R1bGVzLFxuICBtZXRhZmlsZTogdHJ1ZSxcbiAgbWluaWZ5OiBmYWxzZSxcbiAgb3V0ZGlyLFxuICBvdXRFeHRlbnNpb246IHsnLmpzJzogJy5janMnfSxcbiAgcGxhdGZvcm06ICdub2RlJyxcbiAgcmVzb2x2ZUV4dGVuc2lvbnM6IFsnLm1qcycsICcuanMnLCAnLmNqcycsICcuanNvbiddLFxuICBzb3VyY2VtYXA6IHRydWUsXG4gIHRhcmdldDogWydub2RlMTQuMTcuMCddLCAvLyBMVFNcbiAgd3JpdGU6IHRydWUsXG4gIHBsdWdpbnM6IFtcbiAgICBlc3Byb3RvLnBvcENvcHkocG9wQ29weUNvbmZpZyksXG4gICAgbWFuaWZlc3RQbHVnaW4obWFuaWZlc3RQbHVnaW5Db25maWcpLFxuICBdLFxuICB3YXRjaDoge1xuICAgIGFzeW5jIG9uUmVidWlsZChlcnJvciwgcmVzdWx0KSB7XG4gICAgICBidWlsZExvZ0FuZERldk9yU3RvcChyZXN1bHQpO1xuXG4gICAgICBpZiAoZXJyb3IpIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuICAvLyBmb3JtYXQ6ICdpaWUnLFxuICAvLyBvdXRmaWxlOiAnZGlzdC9vdXQuY2pzJyxcbn07XG5cblxuY29uc3QgYnVpbGRSZXN1bHQgPSBhd2FpdCBlc2J1aWxkLmJ1aWxkKGVzYnVpbGRDb25maWcpO1xuaXNCdWlsZCAmJiBidWlsZExvZ0FuZERldk9yU3RvcChidWlsZFJlc3VsdCk7IC8vIGlzRGV2IGhhbmRsZWQgYnkgd2F0Y2gub25SZWJ1aWxkXG4iXX0=