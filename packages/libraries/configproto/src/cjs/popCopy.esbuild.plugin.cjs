"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

exports.__esModule = true;
exports.popCopy = popCopy;
exports.filesToCopy = exports.fileCopy = exports.fileShouldCopy = exports.cache = exports.popCopyConfig = void 0;

require("core-js/modules/esnext.map.delete-all.js");

require("core-js/modules/esnext.map.every.js");

require("core-js/modules/esnext.map.filter.js");

require("core-js/modules/esnext.map.find.js");

require("core-js/modules/esnext.map.find-key.js");

require("core-js/modules/esnext.map.includes.js");

require("core-js/modules/esnext.map.key-of.js");

require("core-js/modules/esnext.map.map-keys.js");

require("core-js/modules/esnext.map.map-values.js");

require("core-js/modules/esnext.map.merge.js");

require("core-js/modules/esnext.map.reduce.js");

require("core-js/modules/esnext.map.some.js");

require("core-js/modules/esnext.map.update.js");

var _path = _interopRequireDefault(require("path"));

var _fsproto = _interopRequireDefault(require("@nodeproto/wtf/fsproto"));

const {
  fs
} = _fsproto.default;
const popCopyConfig = {
  options: [{
    endingWith: /openapi\.(yml|yaml)$/,
    indir: (await _fsproto.default.resolve('../app', import.meta.url)).replace('file://', ''),
    outdir,
    recurse: true
  }]
};
exports.popCopyConfig = popCopyConfig;
const cache = new Map();
exports.cache = cache;

const fileShouldCopy = async sourcepath => {
  let fd;

  try {
    fd = await fs.open(sourcepath, 'r');
    if (!fd) return;
    const {
      mtimeMs
    } = await fd.stat();
    const cacheMs = cache.get(sourcepath)?.ms;
    fd.close();
    return (!cacheMs || cacheMs < mtimeMs) && mtimeMs;
  } catch (e) {
    console.warn('error accessing file, removing from cache\n', {
      sourcepath,
      e
    });
    fd?.close();
    cache.delete(sourcepath);
    return false;
  }
};

exports.fileShouldCopy = fileShouldCopy;

const fileCopy = async (newCacheMs, sourcepath, outdir) => {
  try {
    if (newCacheMs) {
      const outpath = `${outdir}/${_path.default.basename(sourcepath)}`;
      cache.set(sourcepath, {
        ms: newCacheMs,
        outpath
      });
      await fs.mkdir(outdir, {
        recursive: true
      });
      await fs.copyFile(sourcepath, outpath);
    }
  } catch (e) {
    cache.delete(sourcepath);
    console.warn('\n\n error copying file into outdir', {
      sourcepath,
      e
    });
  }
};

exports.fileCopy = fileCopy;

const filesToCopy = options => {
  const msg = 'not copying files:';

  if (!options.length) {
    return console.warn(`${msg} options empty`, options);
  }

  options.forEach(async ({
    outdir,
    endingWith,
    indir,
    recurse,
    ...opts
  }) => {
    try {
      if (!(endingWith instanceof RegExp) || !indir || !indir.startsWith('/') || !outdir || !outdir.startsWith('/')) {
        return console.warn(`${msg} invalid params`, {
          outdir,
          endingWith,
          indir,
          recurse,
          opts
        });
      }

      const sourcedirs = (await fs.readdir(indir, {
        encoding: 'utf8',
        withFileTypes: true
      })) ?? [];
      sourcedirs.forEach(dirEnt => {
        if (!dirEnt.name.includes('.') && recurse) {
          filesToCopy([{
            outdir,
            endingWith,
            recurse,
            indir: `${indir}/${dirEnt.name}`,
            ...opts
          }]);
        } else {
          if (endingWith.test(dirEnt.name)) {
            const sourcepath = `${indir}/${dirEnt.name}`;
            const outpath = `${outdir}/${dirEnt.name}`;
            cache.set(sourcepath, {
              ms: null,
              outpath
            });
          }
        }
      });
    } catch (e) {
      console.error('\n\n error in popcopy', e);
    }
  });
};

exports.filesToCopy = filesToCopy;
const name = 'popCopyPlugin';

function popCopy(config) {
  popCopy.options = config;
  popCopy.onStarted = false;
  return {
    name,

    setup(build) {
      const {
        options
      } = popCopy.options ?? {};
      if (!options) return;
      filesToCopy(options);
      build.onResolve({
        filter: /^popcopy$/
      }, () => ({}));
      build.onStart(async () => {
        if (popCopy.onStarted) return;
        popCopy.onStarted = true;

        if (cache.size) {
          for (const [sourcepath, {
            ms,
            outpath
          }] of cache) {
            try {
              const newCacheMs = await fileShouldCopy(sourcepath);

              if (newCacheMs) {
                await fileCopy(newCacheMs, sourcepath, _path.default.dirname(outpath));
              }
            } catch (e) {
              console.warn('popCopy.onStart error', e);
            }
          }
        }
      });
      build.onEnd(result => {
        popCopy.onStarted = false;
      });
    }

  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzYnVpbGQvcGx1Z2lucy9wb3BDb3B5LmVzYnVpbGQucGx1Z2luLm1qcyJdLCJuYW1lcyI6WyJmcyIsImZzcHJvdG8iLCJwb3BDb3B5Q29uZmlnIiwib3B0aW9ucyIsImVuZGluZ1dpdGgiLCJpbmRpciIsInJlc29sdmUiLCJpbXBvcnQiLCJtZXRhIiwidXJsIiwicmVwbGFjZSIsIm91dGRpciIsInJlY3Vyc2UiLCJjYWNoZSIsIk1hcCIsImZpbGVTaG91bGRDb3B5Iiwic291cmNlcGF0aCIsImZkIiwib3BlbiIsIm10aW1lTXMiLCJzdGF0IiwiY2FjaGVNcyIsImdldCIsIm1zIiwiY2xvc2UiLCJlIiwiY29uc29sZSIsIndhcm4iLCJkZWxldGUiLCJmaWxlQ29weSIsIm5ld0NhY2hlTXMiLCJvdXRwYXRoIiwicGF0aCIsImJhc2VuYW1lIiwic2V0IiwibWtkaXIiLCJyZWN1cnNpdmUiLCJjb3B5RmlsZSIsImZpbGVzVG9Db3B5IiwibXNnIiwibGVuZ3RoIiwiZm9yRWFjaCIsIm9wdHMiLCJSZWdFeHAiLCJzdGFydHNXaXRoIiwic291cmNlZGlycyIsInJlYWRkaXIiLCJlbmNvZGluZyIsIndpdGhGaWxlVHlwZXMiLCJkaXJFbnQiLCJuYW1lIiwiaW5jbHVkZXMiLCJ0ZXN0IiwiZXJyb3IiLCJwb3BDb3B5IiwiY29uZmlnIiwib25TdGFydGVkIiwic2V0dXAiLCJidWlsZCIsIm9uUmVzb2x2ZSIsImZpbHRlciIsIm9uU3RhcnQiLCJzaXplIiwiZGlybmFtZSIsIm9uRW5kIiwicmVzdWx0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBWUE7O0FBQ0E7O0FBR0EsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVNDLGdCQUFmO0FBR08sTUFBTUMsYUFBYSxHQUFHO0FBQzNCQyxFQUFBQSxPQUFPLEVBQUUsQ0FDUDtBQUNFQyxJQUFBQSxVQUFVLEVBQUUsc0JBRGQ7QUFFRUMsSUFBQUEsS0FBSyxFQUFFLENBQUMs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QUFDVixnQkFBSTtBQUNGLG9CQUFNaUIsVUFBVSxHQUFHLE1BQU1mLGNBQWMsQ0FBQ0MsVUFBRCxDQUF2Qzs7QUFDQSxrQkFBSWMsVUFBSixFQUFnQjtBQUNkLHNCQUFNRCxRQUFRLENBQ1pDLFVBRFksRUFFWmQsVUFGWSxFQUdaZ0IsY0FBSytCLE9BQUwsQ0FBYWhDLE9BQWIsQ0FIWSxDQUFkO0FBS0Q7QUFDRixhQVRELENBU0UsT0FBT04sQ0FBUCxFQUFVO0FBQ1ZDLGNBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUNFLHVCQURGLEVBRUVGLENBRkY7QUFJRDtBQUNGO0FBQ0Y7QUFDRixPQTVCRDtBQStCQWlDLE1BQUFBLEtBQUssQ0FBQ00sS0FBTixDQUFZQyxNQUFNLElBQUk7QUFDcEJYLFFBQUFBLE9BQU8sQ0FBQ0UsU0FBUixHQUFvQixLQUFwQjtBQUNELE9BRkQ7QUFHRDs7QUFoRUksR0FBUDtBQWtFRCIsInNvdXJjZXNDb250ZW50IjpbIlxuLyoqXG4gKiBAc2VlIGh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9elI3TE90TWl4OXdcbiAqXG4gKiBwb3BDb3B5IGVzYnVpbGQgcGx1Z2luXG4gKiBjb3BpZXMgZmlsZXMgc3luY2hyb25vdXNseSBiZWZvcmUgRUFDSCBidWlsZCBpbnRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5XG4gKiBjYWNoZXMgcmVzdWx0czogaW5jcmVtZW50YWwgYnVpbGRzID4gdGhhbiBpbml0aWFsXG4gKlxuICogVE9ETzogaHR0cHM6Ly9lc2J1aWxkLmdpdGh1Yi5pby9hcGkvI2luY3JlbWVudGFsXG4gKiBpbXBsZW1lbnQgd2F0Y2hpbmcgeWFtbCBmaWxlc1xuICovXG5cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzcHJvdG8gZnJvbSAnQG5vZGVwcm90by93dGYvZnNwcm90byc7XG5cblxuY29uc3QgeyBmcyB9ID0gZnNwcm90bztcblxuLy8gVE9ETzogdXNlIHRvIGJlIGluIHNvbWUgb3RoZXIgZmlsZVxuZXhwb3J0IGNvbnN0IHBvcENvcHlDb25maWcgPSB7XG4gIG9wdGlvbnM6IFtcbiAgICB7XG4gICAgICBlbmRpbmdXaXRoOiAvb3BlbmFwaVxcLih5bWx8eWFtbCkkLyxcbiAgICAgIGluZGlyOiAoYXdhaXQgZnNwcm90by5yZXNvbHZlKCcuLi9hcHAnLCBpbXBvcnQubWV0YS51cmwpKS5yZXBsYWNlKCdmaWxlOi8vJywgJycpLFxuICAgICAgb3V0ZGlyLFxuICAgICAgcmVjdXJzZTogdHJ1ZSxcbiAgICB9LFxuICBdLFxufTtcbi8vIGNhY2hlIG1hcHBpbmcgeyBmaWxlcGF0aDogeyBpbnB1dCwgb3V0cHV0fSB9XG4vLyBmb3IgdXMgdG8gcmV0dXJuIHRoZSBwcmV2aW91cyBvdXRwdXQgaWYgdGhlIGlucHV0IGhhc250IGNoYW5nZVxuLy8gQUxXQVlTIHVzZSB0aGUgZmlsZXBhdGggYXMga2V5XG4vLyBAc2VlIGh0dHBzOi8vZXNidWlsZC5naXRodWIuaW8vcGx1Z2lucy8jY2FjaGluZy15b3VyLXBsdWdpblxuZXhwb3J0IGNvbnN0IGNhY2hlID0gbmV3IE1hcCgpO1xuXG4vLyBmaWxlU2hvdWxkQ29weShwYXRoKSA9PiBsYXN0TW9kaWZpZWQgaW4gTVMgb3IgdW5kZWZpbmVkXG5leHBvcnQgY29uc3QgZmlsZVNob3VsZENvcHkgPSBhc3luYyBzb3VyY2VwYXRoID0+IHtcbiAgbGV0IGZkO1xuICB0cnkge1xuICAgIGZkID0gYXdhaXQgZnMub3BlbihcbiAgICAgIHNvdXJjZXBhdGgsXG4gICAgICAncidcbiAgICApO1xuICAgIGlmICghZmQpIHJldHVybjtcblxuICAgIGNvbnN0IHsgbXRpbWVNcyB9ID0gYXdhaXQgZmQuc3RhdCgpO1xuICAgIGNvbnN0IGNhY2hlTXMgPSBjYWNoZS5nZXQoc291cmNlcGF0aCk/Lm1zO1xuICAgIGZkLmNsb3NlKCk7XG4gICAgcmV0dXJuICghY2FjaGVNcyB8fCAoY2FjaGVNcyA8IG10aW1lTXMpKSAmJiBtdGltZU1zXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnZXJyb3IgYWNjZXNzaW5nIGZpbGUsIHJlbW92aW5nIGZyb20gY2FjaGVcXG4nLFxuICAgICAgeyBzb3VyY2VwYXRoLCBlIH1cbiAgICApO1xuICAgIGZkPy5jbG9zZSgpO1xuICAgIGNhY2hlLmRlbGV0ZShzb3VyY2VwYXRoKTtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcblxuLy8gY29weSBmaWxlIGludG8gc3BlY2lmaWVkIG91dGRpciAmJiBjYWNoZXMgZmlsZSB0aW1lIGluIG1zXG5leHBvcnQgY29uc3QgZmlsZUNvcHkgPSBhc3luYyAobmV3Q2FjaGVNcywgc291cmNlcGF0aCwgb3V0ZGlyKSA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKG5ld0NhY2hlTXMpIHtcbiAgICAgIGNvbnN0IG91dHBhdGggPSBgJHtvdXRkaXJ9LyR7cGF0aC5iYXNlbmFtZShzb3VyY2VwYXRoKX1gO1xuICAgICAgY2FjaGUuc2V0KFxuICAgICAgICBzb3VyY2VwYXRoLFxuICAgICAgICB7IG1zOiBuZXdDYWNoZU1zLCBvdXRwYXRoIH1cbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IGZzLm1rZGlyKFxuICAgICAgICBvdXRkaXIsXG4gICAgICAgIHsgcmVjdXJzaXZlOiB0cnVlIH1cbiAgICAgIClcbiAgICAgIGF3YWl0IGZzLmNvcHlGaWxlKFxuICAgICAgICBzb3VyY2VwYXRoLFxuICAgICAgICBvdXRwYXRoXG4gICAgICApOyAvLyBkb250IGNhdGNoIGxldCBpdCB0aHJvd1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNhY2hlLmRlbGV0ZShzb3VyY2VwYXRoKTtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnXFxuXFxuIGVycm9yIGNvcHlpbmcgZmlsZSBpbnRvIG91dGRpcicsXG4gICAgICB7IHNvdXJjZXBhdGgsIGUgfVxuICAgICk7XG4gIH1cbn07XG5cbi8vIHNlYXJjaGVzIGZvciBmaWxlcyB0byBjb3B5XG4vLyBzZXRzIGZpbGVwYXRocyBhcyBrZXlzIGluIGNhY2hlXG5leHBvcnQgY29uc3QgZmlsZXNUb0NvcHkgPSBvcHRpb25zID0+IHtcbiAgY29uc3QgbXNnID0gJ25vdCBjb3B5aW5nIGZpbGVzOic7XG5cbiAgaWYgKCFvcHRpb25zLmxlbmd0aCkge1xuICAgIHJldHVybiBjb25zb2xlLndhcm4oXG5gJHttc2d9IG9wdGlvbnMgZW1wdHlgLFxub3B0aW9uc1xuICAgICk7XG4gIH1cblxuICBvcHRpb25zLmZvckVhY2goYXN5bmMgKHsgb3V0ZGlyLCBlbmRpbmdXaXRoLCBpbmRpciwgcmVjdXJzZSwgLi4ub3B0cyB9KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChcbiAgICAgICAgIShlbmRpbmdXaXRoIGluc3RhbmNlb2YgUmVnRXhwKSB8fFxuICAgICAgICAoIWluZGlyIHx8ICFpbmRpci5zdGFydHNXaXRoKCcvJykpIHx8XG4gICAgICAgICghb3V0ZGlyIHx8ICFvdXRkaXIuc3RhcnRzV2l0aCgnLycpKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBjb25zb2xlLndhcm4oXG4gICAgICAgIGAke21zZ30gaW52YWxpZCBwYXJhbXNgLFxuICAgICAgICB7IG91dGRpciwgZW5kaW5nV2l0aCwgaW5kaXIsIHJlY3Vyc2UsIG9wdHMgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzb3VyY2VkaXJzID0gYXdhaXQgZnMucmVhZGRpcihcbiAgICAgICAgaW5kaXIsXG4gICAgICAgIHsgZW5jb2Rpbmc6ICd1dGY4Jywgd2l0aEZpbGVUeXBlczogdHJ1ZSB9XG4gICAgICApID8/IFtdO1xuXG4gICAgICBzb3VyY2VkaXJzLmZvckVhY2goZGlyRW50ID0+IHtcbiAgICAgICAgLy8gY2hlY2sgYWxsIGNoaWxkLWRpcnNcbiAgICAgICAgLy8gbmVlZCB0byBjaGVjayBkaXJFbnRbc3ltYm9sXSB0eXBlID09PSAyXG4gICAgICAgIC8vIGJlY2F1c2UgZHVoIGZpbGVzIHdpdGhvdXQgZXh0ZW5zaW9uc1xuICAgICAgICBpZiAoIWRpckVudC5uYW1lLmluY2x1ZGVzKCcuJykgJiYgcmVjdXJzZSkge1xuICAgICAgICAgIGZpbGVzVG9Db3B5KFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgb3V0ZGlyLFxuICAgICAgICAgICAgICBlbmRpbmdXaXRoLFxuICAgICAgICAgICAgICByZWN1cnNlLFxuICAgICAgICAgICAgICBpbmRpcjogYCR7aW5kaXJ9LyR7ZGlyRW50Lm5hbWV9YCxcbiAgICAgICAgICAgICAgLi4ub3B0c1xuICAgICAgICAgICAgfVxuICAgICAgICAgIF0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIGNoZWNrIGlmIGZpbGVuYW1lIGVuZHNXaXRoIHJlZ2V4XG4gICAgICAgICAgaWYgKGVuZGluZ1dpdGgudGVzdChkaXJFbnQubmFtZSkpIHtcbiAgICAgICAgICAgIC8vIGNoZWNrIGlmIGZpbGVzIHNob3VsZCBiZSBjb3BpZWRcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZXBhdGggPSBgJHtpbmRpcn0vJHtkaXJFbnQubmFtZX1gO1xuICAgICAgICAgICAgY29uc3Qgb3V0cGF0aCA9IGAke291dGRpcn0vJHtkaXJFbnQubmFtZX1gO1xuICAgICAgICAgICAgY2FjaGUuc2V0KFxuICAgICAgICAgICAgICBzb3VyY2VwYXRoLFxuICAgICAgICAgICAgICB7IG1zOiBudWxsLCBvdXRwYXRoIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdcXG5cXG4gZXJyb3IgaW4gcG9wY29weScsXG4gICAgICAgIGVcbiAgICAgICk7XG4gICAgfVxuICB9KTtcbn07XG5cbmNvbnN0IG5hbWUgPSAncG9wQ29weVBsdWdpbic7XG5cbmV4cG9ydCBmdW5jdGlvbiBwb3BDb3B5IChjb25maWcpIHtcbiAgcG9wQ29weS5vcHRpb25zID0gY29uZmlnO1xuICBwb3BDb3B5Lm9uU3RhcnRlZCA9IGZhbHNlO1xuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBzZXR1cCAoYnVpbGQpIHtcbiAgICAgIC8qKlxuICAgICAgICogb3B0aW9uc1xuICAgICAgICogeyBvcHRpb25zOiBbeyBpbmRpciwgZW5kaW5nV2l0aCwgcmVjdXJzZSwgb3V0ZGlyIH1dfVxuICAgICAgICogQGV4YW1wbGVcbiAgICAgICAqICAgICAgICAgIGZpbmRzIGFsbCBmaWxlcyBlbmRpbmdXaXRoIC9vcGVuYXBpXFwuKHltbHx5YW1sKSQvXG4gICAgICAgKiAgICAgICAgICBhbmQgY29waWVzIHRoZW0gaW50byBlc2J1aWxkLmNvbmZpZy5vdXRkaXJcbiAgICAgICAqICAgICAgICAgIHsgb3B0aW9uczogW3tcbiAgICAgICAqICAgICAgICAgICAgICBpbmRpcjogJy9hYnNvbHV0ZS9wYXRoJyxcbiAgICAgICAqICAgICAgICAgICAgICBvdXRkaXI6IC9hYnNvbHV0ZS9wYXRoJ1xuICAgICAgICogICAgICAgICAgICAgIGVuZGluZ1dpdGg6IC9vcGVuYXBpXFwuKHltbHx5YW1sKSQvLFxuICAgICAgICogICAgICAgICAgICAgIHJlY3Vyc2U6IHRydWUsXG4gICAgICAgKiAgICAgICAgICB9XX1cbiAgICAgICAqL1xuICAgICAgY29uc3QgeyBvcHRpb25zIH0gPSBwb3BDb3B5Lm9wdGlvbnMgPz8ge307XG4gICAgICBpZiAoIW9wdGlvbnMpIHJldHVybjtcblxuICAgICAgLy8gU1RFUCAxXG4gICAgICAvLyByZXRyaWV2ZSBhc3NldCBkaXJlY3RvcmllcyBmcm9tIG9wdGlvbnNcbiAgICAgIC8vIHNjYW4gZWFjaCBkaXIgZm9yIGZpbGVzIG1hdGNoaW5nIHByb3ZpZGVkIHJlZ2V4XG4gICAgICAvLyBmb3IgZWFjaCBmaWxlIGZvdW5kIHJ1biBjYWNoZS5zZXQoZmlsZVBhdGgsIHVuZGVmaW5lZClcbiAgICAgIGZpbGVzVG9Db3B5KG9wdGlvbnMpO1xuXG4gICAgICBidWlsZC5vblJlc29sdmUoXG4gICAgICAgIHsgZmlsdGVyOiAvXnBvcGNvcHkkLyB9LFxuICAgICAgICAoKSA9PiAoe30pXG4gICAgICApO1xuICAgICAgLy8gQHNlZSBodHRwczovL2VzYnVpbGQuZ2l0aHViLmlvL3BsdWdpbnMvI3N0YXJ0LWNhbGxiYWNrc1xuICAgICAgYnVpbGQub25TdGFydChhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmIChwb3BDb3B5Lm9uU3RhcnRlZCkgcmV0dXJuO1xuICAgICAgICBwb3BDb3B5Lm9uU3RhcnRlZCA9IHRydWU7XG5cbiAgICAgICAgLy8gU1RFUCAyXG4gICAgICAgIC8vIGxvb3AgY2FjaGUgYW5kIGNvcHkgZmlsZXMgaWYgbmVjZXNzYXJ5XG4gICAgICAgIGlmIChjYWNoZS5zaXplKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBbXG4gICAgICAgICAgICBzb3VyY2VwYXRoLFxuICAgICAgICAgICAgeyBtcywgb3V0cGF0aCB9XG4gICAgICAgICAgXSBvZiBjYWNoZSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3QgbmV3Q2FjaGVNcyA9IGF3YWl0IGZpbGVTaG91bGRDb3B5KHNvdXJjZXBhdGgpO1xuICAgICAgICAgICAgICBpZiAobmV3Q2FjaGVNcykge1xuICAgICAgICAgICAgICAgIGF3YWl0IGZpbGVDb3B5KFxuICAgICAgICAgICAgICAgICAgbmV3Q2FjaGVNcyxcbiAgICAgICAgICAgICAgICAgIHNvdXJjZXBhdGgsXG4gICAgICAgICAgICAgICAgICBwYXRoLmRpcm5hbWUob3V0cGF0aClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICAgICAncG9wQ29weS5vblN0YXJ0IGVycm9yJyxcbiAgICAgICAgICAgICAgICBlXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gQHNlZSBodHRwczovL2VzYnVpbGQuZ2l0aHViLmlvL3BsdWdpbnMvI2VuZC1jYWxsYmFja3NcbiAgICAgIGJ1aWxkLm9uRW5kKHJlc3VsdCA9PiB7XG4gICAgICAgIHBvcENvcHkub25TdGFydGVkID0gZmFsc2U7XG4gICAgICB9KTtcbiAgICB9LFxuICB9O1xufVxuIl19